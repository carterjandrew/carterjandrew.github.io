# Motivation for self hosting
The kindle application is **amazing** it lets you upload books, see them on all your devices, and take great notes in them (something I use a lot).

However it has a glaring issue that really bugs me:  
**No desktop support**

Yes, there is a webapp but that *only lets you view books you've bought through amazon* **for some reason**

![amazon webapp](/booklore/amazon-webapp.png)

^ as you can see here, only some random free books I got as a kid show up... ughhh

Even when I run an android emulator on my computer it won't let me run the kindle application meaning I cannot get any of my book content on my deskop.

On top of this, I'm not exactly enthused with the idea of Amazon having all of my reading data. They could restrict my access to my own content, sell data on what I've been reading, and even tell you my screen time habits.

# My solution
***Disclaimer***
I *self host* whitch means I have a server I can use to host and store this content. If you would be interested in learning how I set that up, drop me a comment or message!

There exists a couple of modern tools that can work together to get every feature I use from kindle *completely for free*. And even, a feature amazon does not have. These are the tools:
1. **[Booklore](https://github.com/booklore-app/)**: a library database and webapp service
2. **[Pocketbook Reader](https://pocketbook.ch/en-ch/app)**: a mobile application that can work with booklore
3. **[Waydroid](https://waydro.id/)**: A wayland android emulator (can be replaced with any other android emulator)

I also use a couple of other technologies that make this easier to do:
1. **[NixOS](https://nixos.org/)**: a operating system that makes it really easy to manage self hosted services like [Booklore](https://github.com/booklore-app/).
2. **[Tailscale](https://tailscale.com/)**: a free vpn connecting all your devices together

# Setting up Booklore
[Booklore has a sample docker compose service](https://github.com/booklore-app/booklore/blob/develop/example-docker/docker-compose.yml) that makes it very easy to start up their service on any computer. For me I used [compose2nix](https://github.com/aksiksi/compose2nix) to turn this container into a nix service that can run on my server. The generated module looks like this:

```nix
# Auto-generated by compose2nix.

{ pkgs, lib, config, ... }:

{
  # Runtime
  virtualisation.podman = {
    enable = true;
    autoPrune.enable = true;
    dockerCompat = true;
  };

  # Enable container name DNS for all Podman networks.
  networking.firewall.interfaces = let
    matchAll = if !config.networking.nftables.enable then "podman+" else "podman*";
  in {
    "${matchAll}".allowedUDPPorts = [ 53 ];
  };

  virtualisation.oci-containers.backend = "podman";

  # Containers
  virtualisation.oci-containers.containers."booklore" = {
    image = "booklore/booklore:latest";
    environment = {
      "BOOKLORE_PORT" = "6060";
      "DATABASE_PASSWORD" = "your_secure_password";
      "DATABASE_URL" = "jdbc:mariadb://mariadb:3306/booklore";
      "DATABASE_USERNAME" = "booklore";
      "FORCE_DISABLE_OIDC" = "false";
      "GROUP_ID" = "0";
      "SWAGGER_ENABLED" = "false";
      "TZ" = "Etc/UTC";
      "USER_ID" = "0";
    };
    volumes = [
      "/root/booklore/example-docker/bookdrop:/bookdrop:rw"
      "/root/booklore/example-docker/books:/books:rw"
			"/root/booklore/example-docker/data:/app/data:rw"
    ];
    ports = [
      "6060:6060/tcp"
    ];
    dependsOn = [
      "mariadb"
    ];
    log-driver = "journald";
    extraOptions = [
      "--network-alias=booklore"
      "--network=booklore_default"
    ];
  };
  systemd.services."podman-booklore" = {
    serviceConfig = {
      Restart = lib.mkOverride 90 "always";
    };
    after = [
      "podman-network-booklore_default.service"
    ];
    requires = [
      "podman-network-booklore_default.service"
    ];
    partOf = [
      "podman-compose-booklore-root.target"
    ];
    wantedBy = [
      "podman-compose-booklore-root.target"
    ];
  };
  virtualisation.oci-containers.containers."mariadb" = {
    image = "lscr.io/linuxserver/mariadb:11.4.5";
    environment = {
      "MYSQL_DATABASE" = "booklore";
      "MYSQL_PASSWORD" = "your_secure_password";
      "MYSQL_ROOT_PASSWORD" = "super_secure_password";
      "MYSQL_USER" = "booklore";
			      "PGID" = "1000";
      "PUID" = "1000";
      "TZ" = "Etc/UTC";
    };
    volumes = [
      "/root/booklore/example-docker/config:/config:rw"
    ];
    log-driver = "journald";
    extraOptions = [
      "--health-cmd=[\"mariadb-admin\", \"ping\", \"-h\", \"localhost\"]"
      "--health-interval=5s"
      "--health-retries=10"
      "--health-timeout=5s"
      "--network-alias=mariadb"
      "--network=booklore_default"
    ];
  };
  systemd.services."podman-mariadb" = {
    serviceConfig = {
      Restart = lib.mkOverride 90 "always";
    };
    after = [
      "podman-network-booklore_default.service"
    ];
    requires = [
      "podman-network-booklore_default.service"
    ];
    partOf = [
      "podman-compose-booklore-root.target"
    ];
    wantedBy = [
      "podman-compose-booklore-root.target"
    ];
  };

  # Networks
  systemd.services."podman-network-booklore_default" = {
    path = [ pkgs.podman ];
		    serviceConfig = {
      Type = "oneshot";
      RemainAfterExit = true;
      ExecStop = "podman network rm -f booklore_default";
    };
    script = ''
      podman network inspect booklore_default || podman network create booklore_default
    '';
    partOf = [ "podman-compose-booklore-root.target" ];
    wantedBy = [ "podman-compose-booklore-root.target" ];
  };

  # Root service
  # When started, this will automatically create all resources and start
  # the containers. When stopped, this will teardown all resources.
  systemd.targets."podman-compose-booklore-root" = {
    unitConfig = {
      Description = "Root target generated by compose2nix.";
    };
    wantedBy = [ "multi-user.target" ];
	};
}
```

This module requires we create a couple of direcories on the host machine:
- `/root/booklore/example-docker/bookdrop`
- `/root/booklore/example-docker/books`
- `/root/booklore/example-docker/data`
- `/root/booklore/example-docker/config`

So you could run 
```bash
mkdir /root/booklore/example-docker/bookdrop
chown booklore /root/booklore/example-docker/bookdrop

mkdir /root/booklore/example-docker/books
chown booklore /root/booklore/example-docker/books

mkdir /root/booklore/example-docker/data
chown booklore /root/booklore/example-docker/data

mkdir /root/booklore/example-docker/config
chown booklore /root/booklore/example-docker/config
```
to set these up.  
Then add the booklore module to the list of imports on your `configuration.nix` file

Now on `localhost:6060` you have a booklore port runing. If you ssh into your computer runnning the service like: 
```bash
ssh -L 6060:localhost:6060 user@your-computer
```
you will be able to see your service running

![booklore-service](/booklore/booklore-local.png)

Cool right??? The people at booklore do cool stuff.

## Accessing that content through a url

We don't want to be reliant on the proxy in ssh to access booklore, so we can use [Tailscale](https://tailscale.com/) to serve this content so *any computer connected to **your** tailscale vpn can see it*

This can be done through the command line on the computer serving our booklore content like this:

```bash
tailscale serve --https=6060 --bg http://localhost:6060
```

or it can be set up in a background service like this:

```nix
systemd.services.tailscale-serve-booklore = {
  description = "Configure Tailscale Serve for Booklore";
  after = [ "network-online.target" "tailscaled.service" ];
  wants = [ "network-online.target" ];
  requires = [ "tailscaled.service" ];
  wantedBy = [ "multi-user.target" ];
  serviceConfig = {
    Type = "oneshot";
    RemainAfterExit = true;
    ExecStart = "${pkgs.tailscale}/bin/tailscale serve --https=6060 --bg http://localhost:6060";
    ExecStop = "${pkgs.tailscale}/bin/tailscale serve --unset-http=6060";
  };
};
```

now if you run 
```bash
tailscale serve status
```

you should see:

```bash
https://your-device.tail9e820.ts.net:6060 (tailnet only)
	|-- / proxy http://localhost:6060
```

Now we if we our booklore service online!

# Setting up booklore OPDS
> OPDS (Open Publication Distribution System) is a standard that enables an open and decentralized distribution network for any digital media.

This will let us connect our mobile apps to our Booklore library.

Here are the steps:

### 1. Open the booklore website
![booklore-website](/booklore/booklore-home.png)
### 2. Navigate to settings
![booklore-website](/booklore/settings-icon.png)
### 3. Enable OPDS Endpoint
![OPDS Endpoint](/booklore/opds-options.png)
### 4. Enable OPDS and create a OPDS user
![OPDS User](/booklore/opds-user.png)

# Adding it to PocketBook

***Disclaimer**:
If you followed the tailscale setup your mobile device will need the tailscale app downloaded and installed on the system

Now you will need to install the [Pocketbook app](https://pocketbook.ch/en-ch/app) on your mobile device and set it up.

## Setting up the remote library
Here is how to link the remote library to Pocketbook:
### Open the books page. 
![Globe icon](/booklore/home.jpg)
### Click on the globe icon
![Globe icon](/booklore/globe-icon.jpg)
This is the category for remote libraries
### Click the add new icon
![Globe icon](/booklore/network-libraries.jpg)
For android this is a plus folder icon, for ios this is a plus icon
### Fill out the form
***Note***:
On android only the `url` and `name` fields show up until you've added the library and *clicked into it*

**URL Field**:

You can find the URL under the OPDS settings in your booklore account
![OPDS URL](/booklore/booklore-opds-url.png)

**Name**:

I just called it `Booklore` but you can put whatever

**Username and Password**:

Insert the username and password of the OPDS user you created

Now your library contents should show up in the application!

![Pocketbook books](/booklore/pocketbook-books.png)

## Setting up a Pocketbook account for note syncing

Now, if you would like, you can also set up Pocketbook to sync any notes, highlight, bookmarks you take on your books using one of their Pocketbook accounts.

To do this simply go into settings in pocketbook, click to add a Pocketbook Cloud account. As long as you choose to not upload recently read books this will only sync the notes, not the books themselves. 

# Setting up a reader on a deskop

Pocketbook does not have a native desktop application, but it is simple enough to run in an android emulator. For me, I use Arch Linux for my operating system and with KDE6 as my desktop enviment it's ideal to use Waydroid for my machine. 

[Guide for installing waydroind on arch](https://wiki.archlinux.org/title/Waydroid#Installation)

### Installing F-Droid
> F-Droid is an installable catalogue of FOSS (Free and Open Source Software) applications for the Android platform. The client makes it easy to browse, install, and keep track of updates on your device.

We can first [download it from here](https://f-droid.org/) and then run

```bash
$ waydroid app install $path_to_apk
```

to install the f-droid apk.

### Installing Auroura Store
> Aurora Store is a Yalp Store fork (Yalp Store is also available on Uptodown) that offers basically all the same features, but from a much more elegant and functional interface. Although it’s a fork, it’s basically the same app, and allows you to download any APK offer on Google Play without a google play account.

Opening f-droid lets us search for `Aurora Store` and install the application

Now you can open Aroura store and search for `Pocketbook` to install that. The process should be the same from there to set up pocketbook

# Conclusion

This gives you a application that can:

1. download your books from a centralized place
2. sync the notes, bookmarks, and highlights you make
3. and do so across all your devices
4. completely for free

I've been loving using it. Hope you do too. Huge thanks to everyone who makes these incredible tools used in this tutorial. Reach out, or drop a comment if you have any questions!
